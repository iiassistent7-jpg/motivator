import os
import time
import threading
import schedule
from datetime import datetime, timedelta
import telebot
import anthropic

# ============================================================
# CONFIGURATION
# ============================================================
TELEGRAM_TOKEN = os.environ.get("TELEGRAM_TOKEN", "")
MY_CHAT_ID = int(os.environ.get("MY_CHAT_ID", "0"))
ANTHROPIC_KEY = os.environ.get("ANTHROPIC_KEY", "")

ISRAEL_UTC_OFFSET = 2

bot = telebot.TeleBot(TELEGRAM_TOKEN)
claude = anthropic.Anthropic(api_key=ANTHROPIC_KEY)

# ============================================================
# HELPERS
# ============================================================
def get_israel_now():
    from datetime import timezone
    return datetime.now(timezone.utc) + timedelta(hours=ISRAEL_UTC_OFFSET)

def today_display():
    months_ru = {
        1: "—è–Ω–≤–∞—Ä—è", 2: "—Ñ–µ–≤—Ä–∞–ª—è", 3: "–º–∞—Ä—Ç–∞", 4: "–∞–ø—Ä–µ–ª—è",
        5: "–º–∞—è", 6: "–∏—é–Ω—è", 7: "–∏—é–ª—è", 8: "–∞–≤–≥—É—Å—Ç–∞",
        9: "—Å–µ–Ω—Ç—è–±—Ä—è", 10: "–æ–∫—Ç—è–±—Ä—è", 11: "–Ω–æ—è–±—Ä—è", 12: "–¥–µ–∫–∞–±—Ä—è"
    }
    days_ru = {
        0: "–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", 1: "–í—Ç–æ—Ä–Ω–∏–∫", 2: "–°—Ä–µ–¥–∞", 3: "–ß–µ—Ç–≤–µ—Ä–≥",
        4: "–ü—è—Ç–Ω–∏—Ü–∞", 5: "–°—É–±–±–æ—Ç–∞", 6: "–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ"
    }
    now = get_israel_now()
    return f"{days_ru[now.weekday()]}, {now.day} {months_ru[now.month]} {now.year}"

# ============================================================
# CLAUDE API
# ============================================================
def call_claude(system_prompt, user_content, max_tokens=2000, retries=3):
    for attempt in range(retries):
        try:
            response = claude.messages.create(
                model="claude-haiku-4-5-20251001",
                max_tokens=max_tokens,
                system=system_prompt,
                messages=[{"role": "user", "content": user_content}]
            )
            return response.content[0].text
        except anthropic.APIStatusError as e:
            if e.status_code == 529 and attempt < retries - 1:
                time.sleep((attempt + 1) * 10)
                continue
            print(f"Claude error: {e.status_code}")
            return None
        except Exception as e:
            print(f"Claude exception: {e}")
            return None

# ============================================================
# BOT PERSONALITY
# ============================================================
BASE_PROMPT = """–¢—ã ‚Äî –ª–∏—á–Ω—ã–π –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–π –∫–æ—É—á –≤ Telegram. –ü–∏—à–µ—à—å –û–î–ù–û–ú–£ —á–µ–ª–æ–≤–µ–∫—É ‚Äî –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—é –∏–∑ –ò–∑—Ä–∞–∏–ª—è, –≤–ª–∞–¥–µ–ª—å—Ü—É —Å–∞–ª–æ–Ω–∞ –∫—Ä–∞—Å–æ—Ç—ã iStudio –≤ –†–∏—à–æ–Ω –ª–µ-–¶–∏–æ–Ω–µ. –ï–≥–æ –∑–æ–≤—É—Ç –ú–∏—à–∞. –£ –Ω–µ–≥–æ —Å–µ–º—å—è, –≤—Ç–æ—Ä–æ–π –±–∏–∑–Ω–µ—Å, –æ–Ω –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è –∑–¥–æ—Ä–æ–≤—å–µ–º –∏ —Å–∞–º–æ—Ä–∞–∑–≤–∏—Ç–∏–µ–º.

–°–¢–ò–õ–¨:
- –ü–∏—à–µ—à—å –∫–∞–∫ –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–µ ‚Äî –∂–∏–≤–æ, –∫—Ä–∞—Ç–∫–æ, —Å –¥—É—à–æ–π
- –ò—Å–ø–æ–ª—å–∑—É–µ—à—å —ç–º–æ–¥–∑–∏ —É–º–µ—Ä–µ–Ω–Ω–æ (2-5 –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ)
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—à—å **–∑–≤—ë–∑–¥–æ—á–∫–∏**, __–ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏—è__, ## –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏–ª–∏ Markdown
- –ü–∏—à–µ—à—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º
- –ú–∞–∫—Å–∏–º—É–º 1500 —Å–∏–º–≤–æ–ª–æ–≤ ‚Äî –∫–æ—Ä–æ—Ç–∫–æ –∏ –º–æ—â–Ω–æ
- –ö–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –∑–∞–∂–∏–≥–∞—Ç—å, –∞ –Ω–µ –±—ã—Ç—å —Å–∫—É—á–Ω–æ–π –ª–µ–∫—Ü–∏–µ–π

–ö–û–ù–¢–ï–ù–¢:
1. –ò–°–¢–û–†–ò–ß–ï–°–ö–ò–ô –§–ê–ö–¢ –î–ù–Ø ‚Äî —á—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ –∏–º–µ–Ω–Ω–æ –≤ —ç—Ç—É –¥–∞—Ç—É –≤ –∏—Å—Ç–æ—Ä–∏–∏. –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å–æ–º, –ø—Ä–µ–æ–¥–æ–ª–µ–Ω–∏–µ–º, –∏–∑–æ–±—Ä–µ—Ç–µ–Ω–∏—è–º–∏, –ø—Ä–æ—Ä—ã–≤–∞–º–∏. –†–µ–∞–ª—å–Ω—ã–µ —Ñ–∞–∫—Ç—ã, –Ω–µ –≤—ã–¥—É–º–∞–Ω–Ω—ã–µ.
2. –¶–ò–¢–ê–¢–ê ‚Äî –æ—Ç –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—è, –ª–∏–¥–µ—Ä–∞, —É—á—ë–Ω–æ–≥–æ, —Ñ–∏–ª–æ—Å–æ—Ñ–∞. –ù–µ –±–∞–Ω–∞–ª—å—â–∏–Ω–∞ —Ç–∏–ø–∞ "–≤–µ—Ä—å –≤ —Å–µ–±—è". –ß—Ç–æ-—Ç–æ —á—Ç–æ —Ä–µ–∞–ª—å–Ω–æ —Ü–µ–ø–ª—è–µ—Ç.
3. –ë–ò–ó–ù–ï–°-–°–û–í–ï–¢ ‚Äî –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π, –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π, –ø—Ä–∏–º–µ–Ω–∏–º—ã–π –ø—Ä—è–º–æ —Å–µ–≥–æ–¥–Ω—è. –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, –ø–µ—Ä–µ–≥–æ–≤–æ—Ä—ã, –ø—Ä–æ–¥–∞–∂–∏, –ø—Å–∏—Ö–æ–ª–æ–≥–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤.
4. –ò–ó–†–ê–ò–õ–¨–°–ö–ò–ô –°–¢–ê–†–¢–ê–ü / –§–ê–ö–¢ ‚Äî –∏—Å—Ç–æ—Ä–∏—è —É—Å–ø–µ—Ö–∞ –∏–∑ –ò–∑—Ä–∞–∏–ª—è, —Å—Ç–∞—Ä—Ç–∞–ø-–Ω–∞—Ü–∏–∏. Waze, Mobileye, Iron Dome, –∏–ª–∏ –º–µ–Ω–µ–µ –∏–∑–≤–µ—Å—Ç–Ω—ã–µ.
5. –Æ–ú–û–† ‚Äî –±–∏–∑–Ω–µ—Å-–∏—Ä–æ–Ω–∏—è, –∞–Ω–µ–∫–¥–æ—Ç, –∑–∞–±–∞–≤–Ω—ã–π —Ñ–∞–∫—Ç. –õ—ë–≥–∫–∏–π, —É–º–Ω—ã–π —é–º–æ—Ä.
6. –í–û–ü–†–û–° –î–õ–Ø –†–ï–§–õ–ï–ö–°–ò–ò ‚Äî –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å –∫–æ—Ç–æ—Ä—ã–π –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç –∑–∞–¥—É–º–∞—Ç—å—Å—è –æ –∂–∏–∑–Ω–∏, –±–∏–∑–Ω–µ—Å–µ, —Ü–µ–ª—è—Ö.

–ù–ï –≤–∫–ª—é—á–∞–π –≤—Å–µ 6 –ø—É–Ω–∫—Ç–æ–≤ –≤ –∫–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ! –í—ã–±–∏—Ä–∞–π 2-3 –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫."""

MORNING_PROMPT = BASE_PROMPT + """

–£–¢–†–ï–ù–ù–ï–ï –°–û–û–ë–©–ï–ù–ò–ï (07:00):
–¢–æ–Ω: –≠–ù–ï–†–ì–ò–ß–ù–´–ô, –∑–∞—Ä—è–∂–∞—é—â–∏–π, –∫–∞–∫ –∫—Ä–µ–ø–∫–∏–π –∫–æ—Ñ–µ. –ü–æ–¥—ä—ë–º –∏ –≤–ø–µ—Ä—ë–¥!
–í–∫–ª—é—á–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ:
- –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π —Ñ–∞–∫—Ç –¥–Ω—è (—á—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ –∏–º–µ–Ω–Ω–æ —Å–µ–≥–æ–¥–Ω—è –≤ –∏—Å—Ç–æ—Ä–∏–∏)
- –¶–∏—Ç–∞—Ç—É –æ—Ç –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—è/–ª–∏–¥–µ—Ä–∞
- –ö–æ—Ä–æ—Ç–∫–∏–π –∑–∞—Ä—è–¥ –Ω–∞ –¥–µ–Ω—å ‚Äî –æ–¥–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∫–∞–∫ –ø–∏–Ω–æ–∫
–ù–∞—á–Ω–∏ —Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –∏ –¥–∞—Ç—ã."""

DAY_PROMPT = BASE_PROMPT + """

–î–ù–ï–í–ù–û–ï –°–û–û–ë–©–ï–ù–ò–ï (13:00):
–¢–æ–Ω: –î–†–£–ñ–ï–õ–Æ–ë–ù–´–ô –ù–ê–°–¢–ê–í–ù–ò–ö, —É–º–Ω—ã–π –¥—Ä—É–≥ –∑–∞ –æ–±–µ–¥–æ–º.
–í–∫–ª—é—á–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ:
- –ë–∏–∑–Ω–µ—Å-—Å–æ–≤–µ—Ç (–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π, –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π)
- –§–∞–∫—Ç –ø—Ä–æ –∏–∑—Ä–∞–∏–ª—å—Å–∫–∏–π —Å—Ç–∞—Ä—Ç–∞–ø –∏–ª–∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—é
- –õ—ë–≥–∫–∏–π —é–º–æ—Ä (–±–∏–∑–Ω–µ—Å-–∞–Ω–µ–∫–¥–æ—Ç –∏–ª–∏ –∏—Ä–æ–Ω–∏—è)
–ù–∞—á–Ω–∏ —Å —á–µ–≥–æ-—Ç–æ —Ç–∏–ø–∞ "–û–±–µ–¥–µ–Ω–Ω—ã–π –ø–µ—Ä–µ—Ä—ã–≤?" –∏–ª–∏ –ø–æ–¥–æ–±–Ω–æ–≥–æ."""

EVENING_PROMPT = BASE_PROMPT + """

–í–ï–ß–ï–†–ù–ï–ï –°–û–û–ë–©–ï–ù–ò–ï (21:00):
–¢–æ–Ω: –°–ü–û–ö–û–ô–ù–´–ô –ú–£–î–†–ï–¶, —Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–∏–π, –≥–ª—É–±–æ–∫–∏–π, –Ω–æ –Ω–µ –∑–∞–Ω—É–¥–Ω—ã–π.
–í–∫–ª—é—á–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ:
- –ò—Å—Ç–æ—Ä–∏—é –ø—Ä–µ–æ–¥–æ–ª–µ–Ω–∏—è (–∫—Ç–æ-—Ç–æ –ø—Ä–æ–≤–∞–ª–∏–ª—Å—è –∏ –ø–æ—Ç–æ–º –ø—Ä–µ—É—Å–ø–µ–ª)
- –í–æ–ø—Ä–æ—Å –¥–ª—è —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏
- –¢—ë–ø–ª–æ–µ –ø–æ–∂–µ–ª–∞–Ω–∏–µ –Ω–∞ –≤–µ—á–µ—Ä ‚Äî –±–µ–∑ —Å–ª–∞–¥–æ—Å—Ç–∏, –ø–æ-–º—É–∂—Å–∫–∏
–ù–∞—á–Ω–∏ —Å —á–µ–≥–æ-—Ç–æ –≤–µ—á–µ—Ä–Ω–µ–≥–æ ‚Äî "–î–µ–Ω—å –Ω–∞ —Ñ–∏–Ω–∏—à–Ω–æ–π –ø—Ä—è–º–æ–π" –∏–ª–∏ –ø–æ–¥–æ–±–Ω–æ–≥–æ."""

# ============================================================
# SAFE SEND
# ============================================================
def safe_send(chat_id, text, max_len=4000):
    if not text:
        text = "–ú–æ—Ç–∏–≤–∞—Ç–æ—Ä –∑–∞–¥—É–º–∞–ª—Å—è... –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ."
    if len(text) <= max_len:
        try:
            bot.send_message(chat_id, text)
        except Exception as e:
            print(f"Send error: {e}")
        return
    parts = []
    while text:
        if len(text) <= max_len:
            parts.append(text)
            break
        split_at = text.rfind("\n\n", 0, max_len)
        if split_at == -1:
            split_at = text.rfind("\n", 0, max_len)
        if split_at == -1:
            split_at = max_len
        parts.append(text[:split_at])
        text = text[split_at:].lstrip("\n")
    for part in parts:
        try:
            bot.send_message(chat_id, part)
            time.sleep(0.3)
        except Exception as e:
            print(f"Send error: {e}")

# ============================================================
# SCHEDULED MESSAGES
# ============================================================
def send_morning():
    now = get_israel_now()
    date_str = today_display()
    prompt = f"–°–µ–≥–æ–¥–Ω—è: {date_str}. –î–∞—Ç–∞: {now.strftime('%d.%m.%Y')}. –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π —É—Ç—Ä–µ–Ω–Ω–µ–µ –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ."
    response = call_claude(MORNING_PROMPT, prompt)
    if response:
        safe_send(MY_CHAT_ID, response)
    else:
        safe_send(MY_CHAT_ID, f"‚òÄÔ∏è –î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! {date_str}\n\nClaude –¥—É–º–∞–µ—Ç... –ù–æ —Ç—ã –Ω–µ –¥—É–º–∞–π ‚Äî –≤—Å—Ç–∞–≤–∞–π –∏ –¥–µ–π—Å—Ç–≤—É–π!")

def send_afternoon():
    now = get_israel_now()
    date_str = today_display()
    prompt = f"–°–µ–≥–æ–¥–Ω—è: {date_str}. –î–∞—Ç–∞: {now.strftime('%d.%m.%Y')}. –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –¥–Ω–µ–≤–Ω–æ–µ –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ."
    response = call_claude(DAY_PROMPT, prompt)
    if response:
        safe_send(MY_CHAT_ID, response)
    else:
        safe_send(MY_CHAT_ID, "üçΩ –û–±–µ–¥–µ–Ω–Ω—ã–π –ø–µ—Ä–µ—Ä—ã–≤!\n\n–°–æ–≤–µ—Ç –¥–Ω—è: —Å–¥–µ–ª–∞–π —Å–µ–≥–æ–¥–Ω—è –æ–¥–Ω—É –≤–µ—â—å –∫–æ—Ç–æ—Ä—É—é –æ—Ç–∫–ª–∞–¥—ã–≤–∞–ª. –¢–æ–ª—å–∫–æ –æ–¥–Ω—É. –ü—Ä—è–º–æ —Å–µ–π—á–∞—Å.")

def send_evening():
    now = get_israel_now()
    date_str = today_display()
    prompt = f"–°–µ–≥–æ–¥–Ω—è: {date_str}. –î–∞—Ç–∞: {now.strftime('%d.%m.%Y')}. –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –≤–µ—á–µ—Ä–Ω–µ–µ –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ."
    response = call_claude(EVENING_PROMPT, prompt)
    if response:
        safe_send(MY_CHAT_ID, response)
    else:
        safe_send(MY_CHAT_ID, "üåô –í–µ—á–µ—Ä.\n\n–í–æ–ø—Ä–æ—Å –Ω–∞ —Å–µ–≥–æ–¥–Ω—è: —á—Ç–æ —Ç—ã —Å–¥–µ–ª–∞–ª —Å–µ–≥–æ–¥–Ω—è, —á–µ–º –±—É–¥–µ—à—å –≥–æ—Ä–¥–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ –≥–æ–¥?\n\n–û—Ç–¥—ã—Ö–∞–π. –ó–∞–≤—Ç—Ä–∞ –Ω–æ–≤—ã–π –¥–µ–Ω—å.")

# ============================================================
# TELEGRAM HANDLERS
# ============================================================
@bot.message_handler(commands=["start"])
def cmd_start(message):
    if message.chat.id != MY_CHAT_ID:
        return
    safe_send(MY_CHAT_ID,
        "üî• –ü—Ä–∏–≤–µ—Ç! –Ø —Ç–≤–æ–π –ª–∏—á–Ω—ã–π –ú–æ—Ç–∏–≤–∞—Ç–æ—Ä.\n\n"
        "–ö–∞–∂–¥—ã–π –¥–µ–Ω—å ‚Äî —Ç—Ä–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:\n\n"
        "‚òÄÔ∏è 07:00 ‚Äî –ó–∞—Ä—è–¥ –Ω–∞ –¥–µ–Ω—å\n"
        "–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π —Ñ–∞–∫—Ç + —Ü–∏—Ç–∞—Ç–∞ + —ç–Ω–µ—Ä–≥–∏—è\n\n"
        "üçΩ 13:00 ‚Äî –ü–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞\n"
        "–ë–∏–∑–Ω–µ—Å-—Å–æ–≤–µ—Ç + –∏–∑—Ä–∞–∏–ª—å—Å–∫–∏–π —Å—Ç–∞—Ä—Ç–∞–ø + —é–º–æ—Ä\n\n"
        "üåô 21:00 ‚Äî –†–µ—Ñ–ª–µ–∫—Å–∏—è\n"
        "–ò—Å—Ç–æ—Ä–∏—è –ø—Ä–µ–æ–¥–æ–ª–µ–Ω–∏—è + –≤–æ–ø—Ä–æ—Å –¥–ª—è —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è\n\n"
        "–ö–æ–º–∞–Ω–¥—ã:\n"
        "/morning ‚Äî —É—Ç—Ä–µ–Ω–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ\n"
        "/afternoon ‚Äî –¥–Ω–µ–≤–Ω–æ–µ\n"
        "/evening ‚Äî –≤–µ—á–µ—Ä–Ω–µ–µ\n"
        "/motivate ‚Äî —Å–ª—É—á–∞–π–Ω–∞—è –º–æ—Ç–∏–≤–∞—Ü–∏—è –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å\n"
        "/fact ‚Äî –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —Ñ–∞–∫—Ç –ø—Ä–æ —Å–µ–≥–æ–¥–Ω—è\n\n"
        "–ò–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å ‚Äî –æ—Ç–≤–µ—á—É –∫–∞–∫ –∫–æ—É—á."
    )

@bot.message_handler(commands=["morning"])
def cmd_morning(message):
    if message.chat.id != MY_CHAT_ID:
        return
    send_morning()

@bot.message_handler(commands=["afternoon"])
def cmd_afternoon(message):
    if message.chat.id != MY_CHAT_ID:
        return
    send_afternoon()

@bot.message_handler(commands=["evening"])
def cmd_evening(message):
    if message.chat.id != MY_CHAT_ID:
        return
    send_evening()

@bot.message_handler(commands=["motivate"])
def cmd_motivate(message):
    if message.chat.id != MY_CHAT_ID:
        return
    now = get_israel_now()
    date_str = today_display()
    prompt = f"–°–µ–≥–æ–¥–Ω—è: {date_str}. –î–∞–π –∫–æ—Ä–æ—Ç–∫—É—é –º–æ—â–Ω—É—é –º–æ—Ç–∏–≤–∞—Ü–∏—é ‚Äî 3-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π. –ß—Ç–æ-—Ç–æ —á—Ç–æ –∑–∞—Ä—è–¥–∏—Ç –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å. –ú–æ–∂–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ü–∏—Ç–∞—Ç—É, —Ñ–∞–∫—Ç, –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –ø–∏–Ω–æ–∫."
    response = call_claude(BASE_PROMPT, prompt)
    if response:
        safe_send(MY_CHAT_ID, response)

@bot.message_handler(commands=["fact"])
def cmd_fact(message):
    if message.chat.id != MY_CHAT_ID:
        return
    now = get_israel_now()
    date_str = today_display()
    prompt = f"–°–µ–≥–æ–¥–Ω—è: {date_str}. –†–∞—Å—Å–∫–∞–∂–∏ 3 —Å–∞–º—ã—Ö –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö —Ñ–∞–∫—Ç–∞ –æ —Ç–æ–º —á—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ –∏–º–µ–Ω–Ω–æ –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å ({now.day} {['', '—è–Ω–≤–∞—Ä—è', '—Ñ–µ–≤—Ä–∞–ª—è', '–º–∞—Ä—Ç–∞', '–∞–ø—Ä–µ–ª—è', '–º–∞—è', '–∏—é–Ω—è', '–∏—é–ª—è', '–∞–≤–≥—É—Å—Ç–∞', '—Å–µ–Ω—Ç—è–±—Ä—è', '–æ–∫—Ç—è–±—Ä—è', '–Ω–æ—è–±—Ä—è', '–¥–µ–∫–∞–±—Ä—è'][now.month]}) –≤ –∏—Å—Ç–æ—Ä–∏–∏. –§–æ–∫—É—Å: –±–∏–∑–Ω–µ—Å, –∏–∑–æ–±—Ä–µ—Ç–µ–Ω–∏—è, –ø—Ä–µ–æ–¥–æ–ª–µ–Ω–∏–µ, –ò–∑—Ä–∞–∏–ª—å."
    response = call_claude(BASE_PROMPT, prompt)
    if response:
        safe_send(MY_CHAT_ID, response)

# ============================================================
# FREE TEXT ‚Äî Coach Mode
# ============================================================
COACH_PROMPT = """–¢—ã ‚Äî –ª–∏—á–Ω—ã–π –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–π –∫–æ—É—á. –ß–µ–ª–æ–≤–µ–∫ (–ú–∏—à–∞, –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å –∏–∑ –ò–∑—Ä–∞–∏–ª—è) –Ω–∞–ø–∏—Å–∞–ª —Ç–µ–±–µ –≤ —á–∞—Ç.
–û—Ç–≤–µ—á–∞–π –∫–∞–∫ –º—É–¥—Ä—ã–π –¥—Ä—É–≥-–Ω–∞—Å—Ç–∞–≤–Ω–∏–∫:
- –ö–æ—Ä–æ—Ç–∫–æ (3-7 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π)
- –ü–æ –¥–µ–ª—É
- –° –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –Ω–æ –±–µ–∑ —Å–ª–∞–¥–æ—Å—Ç–∏
- –ï—Å–ª–∏ –∂–∞–ª—É–µ—Ç—Å—è ‚Äî –Ω–µ –∂–∞–ª–µ–π, –∞ –¥–∞–π –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—É –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥
- –ï—Å–ª–∏ —Ö–≤–∞—Å—Ç–∞–µ—Ç—Å—è ‚Äî –ø–æ—Ä–∞–¥—É–π—Å—è –∏ –ø–æ–¥–Ω–∏–º–∏ –ø–ª–∞–Ω–∫—É –≤—ã—à–µ
- –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Å–æ–≤–µ—Ç ‚Äî –¥–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π, –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π Markdown, —Ç–æ–ª—å–∫–æ —á–∏—Å—Ç—ã–π —Ç–µ–∫—Å—Ç –∏ —ç–º–æ–¥–∑–∏
- –¢–æ–Ω –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤—Ä–µ–º–µ–Ω–∏: —É—Ç—Ä–æ–º –±–æ–¥—Ä—ã–π, –¥–Ω—ë–º –¥–µ–ª–æ–≤–æ–π, –≤–µ—á–µ—Ä–æ–º —Å–ø–æ–∫–æ–π–Ω—ã–π"""

@bot.message_handler(func=lambda m: m.chat.id == MY_CHAT_ID)
def handle_text(message):
    user_text = message.text.strip()
    hour = get_israel_now().hour
    time_context = "—É—Ç—Ä–æ" if hour < 12 else "–¥–µ–Ω—å" if hour < 18 else "–≤–µ—á–µ—Ä"
    prompt = f"–°–µ–π—á–∞—Å {time_context} ({get_israel_now().strftime('%H:%M')}). –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–ø–∏—Å–∞–ª: ¬´{user_text}¬ª"
    response = call_claude(COACH_PROMPT, prompt, max_tokens=1000)
    if response:
        safe_send(MY_CHAT_ID, response)
    else:
        safe_send(MY_CHAT_ID, "–ó–∞–¥—É–º–∞–ª—Å—è... –ù–∞–ø–∏—à–∏ –µ—â—ë —Ä–∞–∑ —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É.")

# ============================================================
# SCHEDULER
# ============================================================
def run_scheduler():
    # Israel times ‚Üí UTC
    morning_utc = 7 - ISRAEL_UTC_OFFSET
    afternoon_utc = 13 - ISRAEL_UTC_OFFSET
    evening_utc = 21 - ISRAEL_UTC_OFFSET

    schedule.every().day.at(f"{morning_utc:02d}:00").do(send_morning)
    schedule.every().day.at(f"{afternoon_utc:02d}:00").do(send_afternoon)
    schedule.every().day.at(f"{evening_utc:02d}:00").do(send_evening)

    print(f"üìã –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ (Israel): 07:00, 13:00, 21:00")
    while True:
        schedule.run_pending()
        time.sleep(30)

# ============================================================
# MAIN
# ============================================================
if __name__ == "__main__":
    print("üî• –ú–û–¢–ò–í–ê–¢–û–† –ù–ê –ü–û–°–¢–£!")
    print(f"üìÖ Israel time: {get_israel_now().strftime('%Y-%m-%d %H:%M')}")

    # Clean start
    bot.delete_webhook(drop_pending_updates=True)
    time.sleep(1)

    scheduler_thread = threading.Thread(target=run_scheduler, daemon=True)
    scheduler_thread.start()
    print("‚è∞ 07:00 —É—Ç—Ä–æ | 13:00 –¥–µ–Ω—å | 21:00 –≤–µ—á–µ—Ä")
    print("üì± Polling...")
    bot.infinity_polling(timeout=60, long_polling_timeout=60)

